/******************************************************************************/
/* IRQ.C: IRQ Handler                                                         */
/******************************************************************************/
/* This file is part of the uVision/ARM development tools.                    */
/* Copyright (c) 2005-2006 Keil Software. All rights reserved.                */
/* This software may only be used under the terms of a valid, current,        */
/* end user licence from KEIL for a compatible version of KEIL software       */
/* development tools. Nothing else gives you the right to use this software.  */
/******************************************************************************/

#include <stm32f10x_lib.h>              /* STM32F10x Library Definitions      */


/***************************************************/
/*					GLOBALS		 			       */
/***************************************************/
   unsigned short sinetable[255] = {128, 131, 134, 137, 141, 144, 147, 150, 153, 156, 159, 162, 165, 168, 171, 174, 177, 
   180, 183, 186, 189, 191, 194, 197, 199, 202, 205, 207, 209, 212, 214, 217, 219, 221, 223, 225, 227, 229, 231, 233, 235, 
   236, 238, 240, 241, 243, 244, 245, 246, 248, 249, 250, 251, 252, 252, 253, 254, 254, 255, 255, 255, 256, 256, 256, 256, 
   256, 256, 256, 255, 255, 254, 254, 253, 253, 252, 251, 250, 249, 248, 247, 246, 245, 243, 242, 240, 239, 237, 236, 234,
   232, 230, 228, 226, 224, 222, 220, 218, 215, 213, 211, 208, 206, 203, 201, 198, 195, 193, 190, 187, 184, 181, 179, 176,
   173, 170, 167, 164, 161, 158, 155, 152, 148, 145, 142, 139, 136, 133, 130, 126, 123, 120, 117, 114, 111, 108, 104, 101,
   98, 95, 92, 89, 86, 83, 80, 77, 75, 72, 69, 66, 63, 61, 58, 55, 53, 50, 48, 45, 43, 41, 38, 36, 34, 32, 30, 28, 26, 
   24, 22, 20, 19, 17, 16, 14, 13, 11, 10, 9, 8, 7, 6, 5, 4, 3, 3, 2, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 
   4, 4, 5, 6, 7, 8, 10, 11, 12, 13, 15, 16, 18, 20, 21, 23, 25, 27, 29, 31, 33, 35, 37, 39, 42, 44, 47, 49, 51, 54, 
   57, 59, 62, 65, 67, 70, 73, 76, 79, 82, 85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 115, 119, 122, 125};

//	unsigned short sinetable[255] = {262, 269, 275, 281, 287, 294, 300, 306, 312, 318, 324, 330, 336, 342, 348, 354, 360, 365, 371, 377, 382, 388, 393, 398, 403, 408, 413, 418, 423, 428, 433, 437, 441, 446, 450, 454, 458, 462, 465, 469, 472, 476, 479, 482, 485, 487, 490, 493, 495, 497, 499, 501, 503, 504, 506, 507, 508, 509, 510, 511, 511, 512, 512, 512, 512, 512, 511, 511, 510, 509, 508, 507, 506, 504, 503, 501, 499, 497,
//495, 493, 490, 487, 485, 482, 479, 476, 472, 469, 465, 462, 458, 454, 450, 446, 441, 437, 433, 428, 423, 418, 413, 408, 403, 398, 393, 388, 382, 377, 371, 365, 360, 354, 348, 342, 336, 330, 324, 318, 312, 306, 300, 294, 287, 281, 275, 269, 262, 256, 250, 243, 237, 231, 225, 218, 212, 206, 200, 194, 188, 182, 176, 170, 164, 158, 152, 147, 141, 135, 130, 124, 119, 114, 109, 104, 99, 94, 89, 84,
//79, 75, 71, 66, 62, 58, 54, 50, 47, 43, 40, 36, 33, 30, 27, 25, 22, 19, 17, 15, 13, 11, 9, 8, 6, 5, 4, 3, 2, 1, 1, 0, 0, 0, 0, 0, 1, 1, 2, 3, 4, 5, 6, 8, 9, 11, 13, 15, 17, 19, 22, 25, 27, 30, 33, 36, 40, 43, 47, 50, 54, 58, 62, 66, 71, 75, 79, 84, 89, 94, 99, 104, 109, 114, 119, 124, 130, 135, 141, 147, 152, 158, 164, 170, 176, 182, 188, 194, 200, 206, 212, 218, 225, 231, 237, 243, 250 };
	unsigned short sine_offset1=0;
	unsigned short sine_offset2=85;
	unsigned short sine_offset3=170;
	extern unsigned short period = 0;
	/* Global variable to be used in main program                                 */
void updateFrequency(unsigned short frequency){
 
 TIM1->ARR =  7200000 / frequency;

}

void EXTI0_IRQHandler(void)
{
  if (EXTI->PR & (1<<0)) {                        // EXTI13 interrupt pending?
    EXTI->PR |= (1<<0);                           // clear pending interrupt

    
  }
}

void TIM3_IRQHandler(void) {
 short unsigned period_new;
 static unsigned short period_old;

 if (TIM3->SR & (1<<3))			 	// PC6
  {	
	period_new = TIM3->CCR1;
	period = period_new - period_old;
	period_old = period_new;
    TIM3->SR &= ~(1<<1);
  }
 
}

void TIM1_UP_IRQHandler (void) {

if (TIM1->SR & 1)			 	// PC6
  {	

   if(sine_offset1==255){
	  	sine_offset1=0;
	  }
	  if(sine_offset2==255){
	  	sine_offset2=0;
	  }
	  if(sine_offset3==255){
	  	sine_offset3=0;
	  }

  TIM1->CCR1 = sinetable[sine_offset3];
  TIM1->CCR2 = sinetable[sine_offset2];	
  TIM1->CCR3 = sinetable[sine_offset1];
  sine_offset1++;
  sine_offset2++;     
  sine_offset3++;	
  
	TIM1->SR &= ~1;
  }
 
}	


/*----------------------------------------------------------------------------
 * end of file
 *---------------------------------------------------------------------------*/


